#!/usr/bin/env bash

set -x

HOSTNAME=`curl -s http://169.254.169.254/openstack/2012-08-10/meta_data.json | python -m json.tool | \grep \"name\": | awk -F '\"' '{print $4}'`
SLAVE_MASTER=`curl -s http://169.254.169.254/openstack/2012-08-10/meta_data.json | python -m json.tool | \grep \"slave-master\": | awk -F '\"' '{print $4}'`
PORT=6002 # 22

if [ -z $SLAVE_MASTER ]; then
    SLAVE_MASTER=localhost
fi

echo $HOSTNAME > /etc/hostname
service hostname restart

if [ $SLAVE_MASTER -ne "localhost" ]; then
    # Set http proxy in sub-slaves
    export http_proxy=http://$SLAVE_MASTER:3128 # squid
    echo export http_proxy=http://$SLAVE_MASTER:3128 > /root/.proxyrc
fi

BRANCH=master
ssh -p $PORT root@$SLAVE_MASTER ls /root/ci-test/\*$HOSTNAME\*-test
if [ "$?" -eq 0 ]; then
    BRANCH=test
fi

# Copy slave scripts from the jenkins.opencontrail.org central master location.
rm -rf /usr/local/jenkins/slave_scripts /root/contrail-infra-config
git clone -b $BRANCH https://github.com/Juniper/contrail-infra-config.git /root/contrail-infra-config
ln -sf /root/contrail-infra-config/modules/jenkins/files/slave_scripts /usr/local/jenkins/slave_scripts
# ssh root@$SLAVE_MASTER -p $PORT tar zcf - /usr/local/jenkins/slave_scripts | tar -zx -C /

set -o pipefail
set -e

# Run the real script
cmd=$1
shift
exec $cmd $*
