---
- name: run puppet
  command: timeout -s 9 30m puppet agent --onetime --ignorecache --no-daemonize --no-usecacheonfailure --no-splay
  register: result
- irc: server={{ ansible_local.irc.default.server }}
       channel={{ ansible_local.irc.default.channel }}
       nick={{ ansible_local.irc.default.nick }}
       msg="puppet failed on {{ ansible_fqdn }}"
  when: result|failed and ansible_local.irc.default.server is defined
