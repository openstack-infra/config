<VirtualHost <%= scope.lookupvar("::logstash::web::vhost_name") %>:80>
    ServerName <%= scope.lookupvar("::logstash::web::vhost_name") %>
    ServerAdmin <%= scope.lookupvar("::logstash::web::serveradmin") %>

    ErrorLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::logstash::web::vhost_name") %>-error.log

    LogLevel warn

    CustomLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::logstash::web::vhost_name") %>-access.log combined

    <% if kibana3 == true %>
    Alias /kibana3 /srv/kibana/kibana-latest
    <Directory /srv/kibana/kibana-latest>
        Allow from all
        Options -Multiviews
    </Directory>
    <% end %>
    <IfModule mod_proxy.c>
        <% if proxy_elasticsearch == true %>
        # Proxy GETs for elasticsearch _aliases, .*/_status, .*/_search,
        # .*/_mapping, _cluster/health, and _nodes.
        RewriteEngine on
        RewriteCond %{REQUEST_METHOD} GET
        RewriteRule ^/elasticsearch/(_aliases|(.*/)?_status|(.*/)?_search|(.*/)?_mapping|_cluster/health|_nodes)$ http://<%= scope.lookupvar("::logstash::web::discover_nodes")[0] %>/$1 [P]
        ProxySet http://<%= scope.lookupvar("::logstash::web::discover_nodes")[0] %>/ connectiontimeout=15 timeout=120
        ProxyPassReverse /elasticsearch/ http://<%= scope.lookupvar("::logstash::web::discover_nodes")[0] %>/
        <% end %>

        ProxyPass / http://127.0.0.1:5601/ retry=0
        ProxyPassReverse / http://127.0.0.1:5601/
    </IfModule>
</VirtualHost>
