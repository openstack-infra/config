---
- hosts: git0*
  gather_facts: false
  max_fail_percentage: 1
  tasks:
    - name: ensure new
      command: rm -rf /var/lib/git/{{ newname }}.git
    - name: rename
      command: mv /var/lib/git/{{ project }}.git /var/lib/git/{{ newname }}.git

- hosts: review.openstack.org
  gather_facts: false
  tasks:
    - name: remove repo
      command: rm -fr ~gerrit2/review_site/git/{{ newname }}.git
    - name: remove mirror
      command: rm -fr /var/lib/git/{{ newname }}.git  # if needed
    - name: move repo
      command: mv ~gerrit2/review_site/git/{{ project }}.git ~gerrit2/review_site/git/{{ newname }}.git
    - name: move mirror
      command: mv /var/lib/git/{{ project }}.git /var/lib/git/{{ newname }}.git

- hosts: review.openstack.org
  gather_facts: false
  remote_user: gerrit2
  tasks:
    - name: Backup old index
      shell: cp -ax review_site/index index.backup.$(date +%s)
    - name: Reindex Gerrit Lucene
      command: java -jar review_site/bin/gerrit.war reindex -d /home/gerrit2/review_site
      async: 45
      poll: 0

- include: clean_workspaces.yaml
