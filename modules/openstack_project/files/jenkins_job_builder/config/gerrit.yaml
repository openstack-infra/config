- job:
    name: check-gerrit-unittests
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - gerrit-preclean
      - shell: |
          #!/bin/bash -xe
          if [ -f pom.xml ];
          then
            mvn clean package -Dgerrit.include-documentation=1 -X -B
          fi
      - gerrit-postrun

    publishers:
      - war:
          site: 'tarballs.openstack.org'
          warfile: 'gerrit-war/target/gerrit*.war'
          target: 'tarballs/ci/test/'
      - console-log

- job:
    name: gate-gerrit-unittests
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - gerrit-preclean
      - shell: |
          #!/bin/bash -xe
          if [ -f pom.xml ];
          then
            mvn clean package -Dgerrit.include-documentation=1 -X -B
          fi
      - gerrit-postrun

    publishers:
      - console-log

- job:
    name: gerrit-package
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - gerrit-preclean
      - shell: |
          #!/bin/bash -xe
          if [ -f pom.xml ];
          then
            mvn clean package -Dgerrit.include-documentation=1 -X -B
          fi
      - gerrit-postrun

    publishers:
      - war:
          site: 'tarballs.openstack.org'
          warfile: 'gerrit-war/target/gerrit*.war'
          target: 'tarballs/ci/gerrit'
      - console-log

- job:
    name: check-gerrit-buck
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - shell: |
          #!/bin/bash -xe
          if [ -f BUCK ];
          then
            buck clean
            buck build gerrit
            buck test --all
          fi

    publishers:
      - console-log

- job:
    name: gate-gerrit-buck
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - shell: |
          #!/bin/bash -xe
          if [ -f BUCK ];
          then
            buck clean
            buck build gerrit
            buck test --all
          fi

    publishers:
      - console-log

- job:
    name: gerrit-package-buck
    node: precise

    wrappers:
      - timeout:
          timeout: 40
          fail: true
      - timestamps

    builders:
      - gerrit-git-prep
      - shell: |
          #!/bin/bash -xe
          /usr/local/jenkins/slave_scripts/maven-properties.sh
      - inject:
          properties-file: maven.properties
      - shell: |
          #!/bin/bash -xe
          if [ -f BUCK ];
          then
            buck clean
            buck build gerrit
          fi
          cp buck-out/gen/gerrit.war buck-out/gen/gerrit-$PROJECT_VER.war

    publishers:
      - war:
          site: 'tarballs.openstack.org'
          warfile: 'buck-out/gen/gerrit-${{PROJECT_VER}}.war'
          target: 'tarballs/ci/gerrit'
      - console-log
