# usig a freestyle project to work around jenkins bug:
# https://issues.jenkins-ci.org/browse/JENKINS-14193

- job-template:
    name: 'gate-{name}-build'
    node: '{node}'

    wrappers:
      - build-timeout:
          timeout: 30
      - timestamps

    builders:
      - revoke-sudo
      - gerrit-git-prep
      - shell: |
          #!/bin/bash -xe
          /usr/local/jenkins/slave_scripts/version-properties.sh
          source version.properties
          mvn clean package -B -Dproject-version=$PROJECT_VER

    publishers:
      - console-log

- job-template:
    name: '{name}-hpi-artifact'
    node: '{node}'

    wrappers:
      - build-timeout:
          timeout: 30
      - timestamps

    builders:
      - revoke-sudo
      - gerrit-git-prep
      - shell: |
          #!/bin/bash -xe
          /usr/local/jenkins/slave_scripts/version-properties.sh
          source version.properties
          mvn clean package -B -Dproject-version=$PROJECT_VER
          cp ./target/{name}.hpi ./target/{name}-$PROJECT_VER.hpi

    publishers:
      - war:
          site: '{tarball-site}'
          warfile: 'target/{name}-*.hpi'
          target: 'tarballs/ci/{name}'
      - console-log

- job-template:
    name: '{name}-jenkinsci-upload'
    node: pypi

    builders:
      - revoke-sudo
      - shell: |
          /usr/local/jenkins/slave_scripts/artifact-publish.sh \
          -a jenkins-plugin -p {name}
    publishers:
      - console-log

- job-group:
    name: jenkins-plugin-jobs
    jobs:
      - 'gate-{name}-build'
      - '{name}-hpi-artifact'
      - '{name}-jenkinsci-upload'
