- job:
    name: gate-opencontrailid-unittests
    node: 'bare-precise'

    builders:
        - gerrit-git-prep
        - shell: |
            #!/bin/bash -xe
            /usr/local/jenkins/slave_scripts/php-laravel-build.sh
    publishers:
        - console-log
        - coverage-log
        - scp:
            site: 'static.opencontrail.org'
            files:
                - target: 'logs/$LOG_PATH'
                  source: './reports/**'
                  keep-hierarchy: true
                  copy-after-failure: true

- job-template:
    name: 'opencontrailid-release-{branch-designator}'
    node: '{node}'

    builders:
        - gerrit-git-prep
        - shell: |
            #!/bin/bash -xe
            /usr/local/jenkins/slave_scripts/maven-properties.sh
        - inject:
            properties-file: maven.properties
        - shell: |
            #!/bin/bash -xe
            /usr/local/jenkins/slave_scripts/php-laravel-build.sh
            # Clone to dist
            rm -rf dist
            mkdir dist
            rsync -arv --exclude ".git*" --exclude tarballs --exclude dist . dist
            # Clean/create a tarball directory
            rm -rf tarballs
            mkdir -p tarballs
            # Create an archive tarball.
            tar -czf opencontrailid-$PROJECT_VER.tar.gz dist/
            cp opencontrailid-$PROJECT_VER.tar.gz tarballs/opencontrailid-latest.tar.gz
            mv opencontrailid-$PROJECT_VER.tar.gz tarballs/
    publishers:
        - console-log
        - coverage-log
        - scp:
            site: 'static.opencontrail.org'
            files:
                - target: 'logs/$LOG_PATH'
                  source: './reports/**'
                  keep-hierarchy: true
                  copy-after-failure: true
                - target: 'tarballs/opencontrailid/'
                  source: 'tarballs/*.tar.gz'
                  keep-hierarchy: false
                  copy-after-failure: false
