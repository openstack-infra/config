# TODO(mordred) Update this to use required-projects. When we do
# we'll need to mv the zuul-cloned plugin repos to be subdirs of
# the gerrit repo.
- name: Clone main gerrit repo
  git:
    repo: https://gerrit.googlesource.com/gerrit
    dest: /home/zuul/src/gerrit.googlesource.com/gerrit
    force: yes
    recursive: yes
    version: stable-2.15

- name: Clone plugin repos
  git:
    repo: "https://gerrit.googlesource.com/plugins/{{ item }}"
    dest: "/home/zuul/src/gerrit.googlesource.com/gerrit/plugins/{{ item }}"
    force: yes
    recursive: yes
    version: stable-2.15
  loop: &gerrit_plugins
    - its-storyboard
    - its-base
    - javamelody
    - verify-status
    - delete-project
    - importer

- name: Configure plugin bazel file
  lineinfile:
    path: /home/zuul/src/gerrit.googlesource.com/gerrit/tools/bzl/plugins.bzl
    insertafter: "# Add custom core plugins here"
    line: '"{{ item }}",'
  loop: *gerrit_plugins

- name: Configure external plugin deps
  copy:
    force: yes
    src: external_plugin_deps.bzl
    path: /home/zuul/src/gerrit.googlesource.com/gerrit/plugins/external_plugin_deps.bzl
