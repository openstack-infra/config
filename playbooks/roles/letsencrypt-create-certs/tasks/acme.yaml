- name: 'Build arguments for letsencrypt acme.sh driver for: {{ item.key }}'
  set_fact:
    acme_args: '"{% for domain in item.value %}-d {{ domain }} {% endfor %}"'

- name: 'Run acme.sh driver for {{ item.key }} certificate issue'
  shell:
    cmd: |
      /opt/acme.sh/driver.sh {{ 'selfsign' if letsencrypt_test_only else 'renew' }}  {{ acme_args }}
  args:
    chdir: /opt/acme.sh/
  register: acme_output

- debug:
    var: acme_output.stdout_lines

# Keys generated!

- name: 'Reload Apache if requested'
  service:
    # Currently this only supports debuntu hosts
    name: apache2
    state: reloaded
  # Apache will only install new certs on full restart not reload.
  when: letsencrypt_restart_apache | default(false) | bool
