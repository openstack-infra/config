- name: Build arguments for letsencrypt acme.sh driver
  set_fact:
    acme_args: >-
      {% for cert in letsencrypt_certs[inventory_hostname] %}
      "{% for domain in letsencrypt_certs[inventory_hostname][cert] %}
      -d {{ domain }}
      {% endfor %}"
      {% endfor %}

- name: Generate fake self-signed certs
  shell:
    # - any need to make SAN for other domains?
    # - fake fullchain
    cmd: |
      set -o xtrace
      domain={{ item.value[0] }}
      mkdir -p /etc/letsencrypt-certs/${domain}
      cd /etc/letsencrypt-certs/${domain}

      openssl genrsa -out ${domain}.key 2048
      openssl rsa -in ${domain}.key -out ${domain}.key
      openssl req -sha256 -new -key ${domain}.key -out ${domain}.csr -subj '/CN=localhost'
      openssl x509 -req -sha256 -days 365 -in ${domain}.csr -signkey ${domain}.key -out ${domain}.cer
      cp ${domain}.cer fullchain.cer
      find /etc/letsencrypt-certs
  loop: "{{ letsencrypt_certs[inventory_hostname] | dict2items }}"

#- name: Run acme.sh driver for certificate renewal
#  shell:
#    cmd: |
#      /opt/acme.sh/driver.sh renew {{ acme_args }}
#  args:
#    chdir: /opt/acme.sh/
#  register: acme_output
