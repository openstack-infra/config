---
- hosts: '!puppetmaster.openstack.org:!disabled'
  gather_facts: false
  tasks:
  - synchronize:
      src: /opt/system-config/production
      dest: /opt/system-config
  - synchronize:
      src: /etc/puppet/modules
      dest: /etc/puppet
  - name: Check whether to upgrade certain modules
    opt_in_to_upgrade_modules:
    register: opt_in
  - name: Upgrade certain modules
    shell: MODULE_FILE=upgrade-modules.env /opt/system-config/production/install_modules.sh
    when: "{{ opt_in.opt_in_to_upgrade|bool }}"
  - file:
      path: /etc/puppet/hieradata
      state: directory
      mode: 0700
      owner: root
      group: root
  - file:
      src: /etc/puppet/hieradata
      dest: /opt/system-config/hieradata
      state: link
