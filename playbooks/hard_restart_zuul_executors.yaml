---
- hosts: 'ze*.openstack.org'
  # Do the entire play completely for one host at a time
  serial: 1
  any_errors_fatal: true
  tasks:
    - name: Slurp pid of zuul-executor
      slurp:
        src: /var/run/zuul-executor/zuul-executor.pid
      register: zuul_pid

    - name: Hard stop zuul-executor
      service:
        name: zuul-executor
        state: stopped
      become: true
      become_user: root

    - name: Wait for 15 minutes for zuul-executor to stop
      wait_for:
        path: "/proc/{{ zuul_pid.content | b64decode }}/status"
        state: absent
        timeout: 900

    # There should be nothing left here ...
    - name: Check for remaining processes
      shell: "ps -aef | grep [z]uul-exector"
      register: ps_result
    - debug:
        var: ps_result.stdout_lines

    - name: Start zuul-executor
      service:
        name: zuul-executor
        state: started
      become: true
      become_user: root
