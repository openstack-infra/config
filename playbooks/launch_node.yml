---
- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - { role: generate_tmp_keypair }
    - { role: create_openstack_keypair }
    - { role: cloud-launcher }

- hosts: cl_servers_just_created
  remote_user: ubuntu
  become: yes
  gather_facts: no
  pre_tasks:
    - set_fact: ansible_ssh_private_key_file={{ key_folder|default('/tmp') }}/{{ key_name|default('tmpkey') }}
    - local_action: wait_for port=22 host="{{ ansible_ssh_host | default(inventory_hostname) }}" delay=30
  roles:
    - { role: bootstrap_puppet }

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - { role: delete_tmp_keypair }
    - { role: delete_openstack_keypair }
