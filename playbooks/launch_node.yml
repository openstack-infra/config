---
- hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    clouds: []
    servers: []
  pre_tasks:
    - set_fact:
        servers: "{{ servers + [{'name': name,
                                 'image': image,
                                 'flavor': flavor,
                                 'network': network,
                                 'volumes': volumes,
                                }] }}"
    - set_fact:
        clouds: "{{ clouds + [{'name':cloud,'servers': servers}] }}"
  roles:
    - { role: cloud-launcher, generate_keypair: yes }

- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - wait_for: port=22 host={{ hostvars[item]['ansible_ssh_host'] }} search_regex=OpenSSH delay=60
      with_items: "{{ groups['cl_servers_just_created'] }}"

- hosts: cl_servers_just_created
  remote_user: "{{ configure_node_remote_user|default('ubuntu') }}"
  become: yes
  gather_facts: no
  pre_tasks:
    - set_fact: ansible_ssh_private_key_file={{ cl_generated_keypair_private_key_filename }}
  roles:
    - { role: make_swap }
    - { role: bootstrap_puppet }
    - { role: set_hostname }
    - { role: puppet, manage_config: true }
  post_tasks:
    - shell: reboot

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - { role: delete_ssh_keypair, key_name: cl_generated_keypair_name }
    - { role: delete_openstack_keypair }
