---
- hosts: localhost
  connection: local
  gather_facts: yes
  pre_tasks:
    - set_fact: key_name=launch-{{ ansible_date_time.epoch }}
  vars:
    clouds: []
    servers: []
  pre_tasks:
    - set_fact: key_name=launch-{{ ansible_date_time.epoch }}
    - set_fact: public_key_file=/tmp/{{ key_name }}.pub
    - set_fact:
        servers: "{{ servers + [{'name': name,
                                 'image': image,
                                 'flavor': flavor,
                                 'key_name': key_name}] }}"
    - set_fact:
        clouds: "{{ clouds + [{'name':cloud,'servers': servers}] }}"
  roles:
    - { role: generate_tmp_keypair }
    - { role: create_openstack_keypair }
    - { role: cloud-launcher }

- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - wait_for: port=22 host={{ hostvars[item]['ansible_ssh_host'] }} search_regex=OpenSSH delay=60
      with_items: "{{ groups['cl_servers_just_created'] }}"

- hosts: cl_servers_just_created
  remote_user: "{{ bootstrap_puppet_remote_user|default('ubuntu') }}"
  become: yes
  gather_facts: no
  pre_tasks:
    - set_fact: ansible_ssh_private_key_file={{ key_folder }}/{{ key_name }}
  roles:
    - { role: bootstrap_puppet }
    - { role: set_hostname }
    - { role: puppet, manage_config: true }
  post_tasks:
    - shell: reboot

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - { role: delete_tmp_keypair }
    - { role: delete_openstack_keypair }
